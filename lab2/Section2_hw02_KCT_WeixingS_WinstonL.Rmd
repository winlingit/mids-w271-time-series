---
title: "Statistical Methods for Discrete Response, Time Series, and Panel Data (W271): Lab 1"
date: 'July 2, 2017'
author: "K.C. Tobin, Weixing Sun, Winston Lin"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### The purpose of this lab is to practice using Poisson Regression models, conduct residual diagnostics, and examine goodness of fit. 

- Do question 23, 24, 25 in C Chapter 5 (page 351 and 352) of Bilder and Loughin's \textit{Analysis of Categorical Data with R}.

- Even though it is not included in these questions, conduct a comprehensive Exploratory Data Analysis (EDA) analysis, which includes both graphical and tabular analysis, as taught in this course.

```{r pressure, echo=FALSE}
library(data.table)
library(ggplot2)
library(ggExtra)
library(GGally)

# read dataset
dt = data.table(read.csv('HorseshoeCrabs.csv', header = TRUE, sep = ',', row.names = NULL))

# convert to factors
dt[, sat.fac := factor(Sat)][, Color := factor(Color)][, Spine := factor(Spine)]

# extract and summaries
head(dt)
tail(dt)
summary(dt)  # medians: width = 26.1, weight = 2.35, sat = 2.0

# parallel coordinate plot
plt1 = ggparcoord(dt, columns = 1:(ncol(dt) - 3), groupColumn = 'sat.fac', alphaLines = 0.3, scale = 'uniminmax')
plt1 + labs(title = 'Horseshoe Crab Data', y = 'Scale 0-1')

# scatterplots for all variables
plt2 = ggplot(dt, aes(x = Width, y = Weight))
plt2 + geom_point(aes(size = Sat, color = Color, shape = Spine, alpha = 0.3)) +
        labs(title = 'Horseshoe Crab Data', x = 'Width', y = 'Weight') + facet_grid(Spine ~ Color, labeller = label_both)
```
5.23. Agresti (2007) provides data on the social behavior of horseshoe crabs. These data are contained in the HorseshoeCrabs.csv file available on our website. Each observation corresponds to one female crab. The response variable is Sat, the number of “satellite” males in her vicinity. Physical measurements of the female—Color (4-level ordinal), Spine (3-level ordinal), Width (cm), and Weight (kg)—are explanatory variables.

a. Fit a Poisson regression model with a log link using all four explanatory variables in a linear form. Test their significance and summarize results.

LRT shows moderate evidence that color has a significant effect (p-value < 0.05) on the mean count of satellite males and strong evidence that weight does so as well (p-value < 0.003.  Specifically, darker and heavier females are associated with higher counts of satellite males. 

```{r}
# fit model
glm.Ha = glm(formula = Sat ~ Color + Spine + Width + Weight, family = poisson(link = 'log'), data = dt)
summary(glm.Ha)

# LRT to check significance of variables
Anova(glm.Ha)
```

b. Compute deviance/df and interpret its value.

Deviance/df is 3.33 and greater than 1.18, the threshold indicating that the model is a poor fit in Bilder (p. 293).


```{r}

# null model
glm.Ho = glm(formula = Sat ~ 1, family = poisson(link = 'log'), data = dt)
summary(glm.Ho)

# LRT to calculate deviance and df
lrt = anova(glm.Ho, glm.Ha, test = 'Chisq')
dev.df = lrt$`Resid. Dev`/lrt$`Resid. Df`
dev.df[2]

t1 = 1 + 2*sqrt(2/lrt$`Resid. Dev`[2])
t1

t2 = 1 + 3*sqrt(2/lrt$`Resid. Dev`[2])
t2
```


c. Examine residual diagnostics and identify any potential problems with the model.

The residuals are not normally distributed with mean 0 and are heteroskedastic.  This means that there is a correlation between the errors and another explanatory variable that is not accounted for by the model.

```{r}

# residual plots
plot(glm.Ha$residuals)
hist(glm.Ha$residuals)
qqnorm(glm.Ha$residuals)
```

d. Carry out the GOF test described on page 296 using the PostFitGOFTest() function available in the PostFitGOFTest.R program of the same name from our website. Use the default number of groups. (M/5 when M = 100)

i. State the hypotheses, test statistic and p-value, and interpret the results.

$H_o:$ The model is correct (fits well).
$H_a:$ The model is incorrect (fits poorly).

The goodness-of-fit test yield a Pearson statistic of 56.0

```{r}

# from Ch. 5 in Bilder
PostFitGOFTest = function(obs, pred, g = 0) {
  if(g == 0) g = round(min(length(obs)/5,20))
 ord <- order(pred)
 obs.o <- obs[ord]
 pred.o <- pred[ord]
 interval = cut(pred.o, quantile(pred.o, 0:g/g), include.lowest = TRUE)  # Creates factor with levels 1,2,...,g
 counts = xtabs(formula = cbind(obs.o, pred.o) ~ interval)
 centers <- aggregate(formula = pred.o ~ interval, FUN = "mean")
 pear.res <- rep(NA,g)
 for(gg in (1:g)) pear.res[gg] <- (counts[gg] - counts[g+gg])/sqrt(counts[g+gg])
 pearson <- sum(pear.res^2)
 if (any(counts[((g+1):(2*g))] < 5))
  warning("Some expected counts are less than 5. Use smaller number of groups")
 P = 1 - pchisq(pearson, g - 2)
 cat("Post-Fit Goodness-of-Fit test with", g, "bins", "\n", "Pearson Stat = ", pearson, "\n", "p = ", P, "\n")
 return(list(pearson = pearson, pval = P, centers = centers$pred.o, observed = counts[1:g], expected = counts[(g+1):(2*g)], pear.res = pear.res))
}

# run GOF test
gof.test = PostFitGOFTest(dt$Sat, glm.Ha$fitted.values)
```

ii. Plot the Pearson residuals for the groups against the interval centers (available in the pear.res and centers components, respectively, of the list returned by the function). Use this plot and the residual plots from part (c) to explain the results.

The plot of Pearson residuals vs. the interval centers confirms the idea that...

```{r}
# scatterplots for Pearson residuals and interval centers
df = data.frame(cbind(pear.res = gof.test$pear.res, centers = gof.test$centers))
plt2 = ggplot(df, aes(x = pear.res, y = centers))
plt2 + geom_point() + labs(title = 'Horseshoe Crab Data', x = 'Pearson residual', y = 'Interval center')
```

5.24. Continuing Exercise 23, conduct an influence analysis. Interpret the results.

```{r}

# influence of points - Cook's distance, leverage

```

5.25. Continuing Exercise 23, notice that there is one crab with a weight that is substantially different from the rest. This can be seen, for example, in a histogram of the weights. Remove this crab from the data and repeat the steps from Exercise 23. Has this fixed any problems with the model? Are there any other problems with the model, and what could be done to solve these problems?

```{r}

```

