---
title: "Lab 2"
author: "K.C. Tobin"
date: "June 29, 2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_knit$set(root.dir = "C:/Users/kctob/OneDrive/Documents/Berkeley/271/mids-w271-time-series/lab2")
library(car)
library(stargazer)
library(Hmisc)
library(effects)
```

# The Lab
  
  - Even though it is not included in these questions, conduct a comprehensive Exploratory Data Analysis (EDA) analysis, which includes both graphical and tabular analysis, as taught in this course.

    - According to online information of this study,
    - Color = female crab’s color (1,2,3,4; 1=lightest to 4=darkest)
    - Spine = female crab’s spine condition (1 = both good, 2= one worn or broken, 3=both worn or broken)
    - Width = female crab’s carapace width (cm)
    - Weight = female crab’s weight (kg)


```{r, warning=FALSE}
hs <- read.csv("HorseshoeCrabs.csv")
hs$Color.cat <- factor(hs$Color, labels = c("very light", "light", "dark", "very dark"))
hs$Spine.cat <- factor(hs$Spine, labels = c("2 good", "1 good", "0 good"))
scatterplotMatrix(hs[c(3,4,5)])
```
- Insights from scatterplots: 1. width and weight has a clear positive linear correlation, which makes sense since a heavier horse shoe crab should be wider; 2. Sat shows a frequency distribution that might be fitted by poisson model.

```{r}
xtabs(~Color.cat + Spine.cat, data = hs)
boxplot(hs$Sat~hs$Color.cat)
boxplot(hs$Sat~hs$Spine.cat)
```
- Insights from the contigency table and boxplots: 1. For Color, only a few data points locate in the level "very light", which may give rise to a large uncertainty of fitting; 2. For Spine, only a few data points locate in the level "1 good", which may also give rise to a large uncertainty of fitting.

23. Agresti (2007) provides data on the social behavior of horshoe crabs. These data are contained in hte HorseshoesCrabs.csv file available on our website. Each observation corresponds to one female crab. The response variable is Sat, the number of "satellite" males in her vicinity. Physical measurements of the female - Color (4-level ordinal), Spine (3-level ordinal), Width (cm), and Weight (kg) - are explanatory variables.
  
    a) Fit a Poisson regression model with a log link using all four explanatory variables in a linear form. Test their significance and summarize results.
    
```{r}
# Poisson with ordinal variables
mod1 <- glm(Sat ~ Color + Spine + Width + Weight, family = poisson(link="log"), data=hs)
summary(mod1)
Anova(mod1)
```

  - Results show that only Color and Weight parameters are statistically significant. LRT also shows strong evidence that the effects of color and weight are statistically significant (p-value < 0.05).

```{r}
# Poisson with categorical variables
mod2 <- glm(Sat ~ Color.cat + Spine.cat + Width + Weight, family = poisson(link="log"), data=hs)
summary(mod2)
Anova(mod2)
```

  - Next, we transform Color and Spine to categorical variables to run Poisson fitting again. It shows similar results with mod1. However, it is noticable that only dark colors (3 & 4) show a significant effect on satellites.

b) Compute deviance/df and interpret its value.
```{r}
# calculate residual deviance of Color in mod1
mod1.1 = glm(Sat ~ Spine + Width + Weight, family = poisson(link="log"), data=hs)
anova(mod1.1, mod1, test = "Chisq")
# calculate residual deviance of Weight in mod1
mod1.2 = glm(Sat ~ Color + Spine + Width, family = poisson(link="log"), data=hs)
anova(mod1.2, mod1, test = "Chisq")
# calculate residual deviance of Color in mod2
mod2.1 = glm(Sat ~ Spine.cat + Width + Weight, family = poisson(link="log"), data=hs)
anova(mod2.1, mod2, test = "Chisq")
# calculate residual deviance of Weight in mod2
mod2.2 = glm(Sat ~ Color.cat + Spine.cat + Width, family = poisson(link="log"), data=hs)
anova(mod2.2, mod2, test = "Chisq")
```
- By anova(), we compared two models with and without one parameter, i.e, we test the hypothesis $H_0: \beta_i = 0$ First, we studied Weight and Color in mod1 (with ordinal values). For Color, Deviance is 7.969 and it is statistiaclly significant. For Weight, Deviance is 8.3329 and it is statistiaclly significant. Next, we studied Weight and Color in mod1 (with categorical values). Similarly, both Color and Weight are statistically significant by Deviance. However, it is noticable that p-value of Color decreases. Df of Color is 3 in mod2 because Color has 4 categories.
   
    c) Examine residual diagnostics and identify any potential problems with the model.
```{r, warning=FALSE}
#plot(allEffects(mod2))
residualPlots(mod2)
```
  - Residual plots show that there is no systematic patterns fo residual distribution, except for a few outliners. E(u|x) is slightly away from 0, while the homoskedaticity is highly preserved. Again, there are a few outliners that deviate expected residuals from 0. More influence of outliners will be discussed in 24.
  
24. Conduct an influence analysis. Interpret the results.

```{r}
plot(mod1)
plot(mod2)
```

- In mod1 (ordinal), only one data point (No.165) shows a Cook's distance above 0.5, meaning a high influence on the fitting. In mod2 (categorical), this outliner shows a Cook's distance slightly below 0.5. The influence of this outliner is reduced by mod2, contributing to a more accurate fitting. 

25. Remove the influential crab from the analysis and repeat the steps in Question 23. Has this fixed the problems with the model? Are there any other problems with the model, and what could be done to solve these problems?

```{r}
hs2 <- hs[-165,]
# compare mod1 and mod1.3(without the outliner)
mod1.3 <- glm(Sat~Color+Spine+Width+Weight, family = poisson(link="log"), data=hs2)
#summary(mod1.3)
#Anova(mod1.3)
stargazer(mod1,mod1.3,type="text")

# compare mod2 and mod2.3(without the outliner)
mod2.3 <- glm(Sat ~ Color.cat + Spine.cat + Width + Weight, family = poisson(link="log"), data=hs2)
#summary(mod2.3)
#Anova(mod2.3)
stargazer(mod2,mod2.3,type="text")

#preds2 <- predict(mod, hs)
#obs2 <- hs$Sat
#results2 <- PostFitGOFTest(obs2,preds2)
#results2
#plot(results2$pear.res~results2$centers)
```

- In both (ordinal and categorical) models, the removal of the outliner mildly decreases the significance of Color and mildly increases the significance of Weight. The influence of the outliner is limited.

- Other possible problems include: 1. Random sampling: From the Q-Q plot above in Problem 24, we can observe that the residual is not well normally distributed. From other residual plots, we observed a slight heteroscedasticity. We have no information about sampling in this study. But a better randomly selected sample and independently and identiacally distributed observations will help on a better model fitting. 2. Interactions between parameter. It is possible that weight and color, or spine and color, have interactions. Though it is not studied here, the interaction term may be statistically significant and improve model fitting.